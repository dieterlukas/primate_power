---
title: "IntersexDominance"
author: "Elise Huchard, Peter Kappeler, Claudia Fichtel, Nikos Smit, Dieter Lukas"
date: '`r Sys.Date()`'
output:
  html_document: 
    toc: true
    toc_depth: 4
    toc_float: 
      collapsed: false
    code_folding: hide 
  github_document: 
    toc: true
  pdf_document:
    keep_tex: yes
    latex_engine: xelatex
  md_document: 
    toc: true
---


### This file contains the R script with the analyses reported in the manuscript:

## The evolution of male-female dominance relations in primate societies
Males were long believed to dominate females socially in all but a few mammals. However, recent studies indicate more variation, opening new possibilities for exploring the extent and drivers of sex biases in social dominance. Here, we use comparative data from 226 populations of 117 primate species to show that male-female conflicts represent nearly half of all within-group conflicts, and that male dominance is far from ubiquitous. In fact, 82% of all populations show either moderate sex biases or female-biased dominance. Finally, our analyses support a scenario of sexual conflict, where the sex that acquires more control over reproduction ultimately dominates the other. Overall, these results may also contribute to a better understanding of the evolutionary origins of gender asymmetries in power in human societies.


# The script can be used to load the required data from the repository at http://github.com/dieterlukas/primate_power , run the analyses, and generate the figures.



```{r load data}



# Loading the relevant packages for tree manipulation (ape/geiger), data wrangling (dplyr), 
# and Bayesian analyses (rethinking/cmdstanr). To install these latter two packages, please see: https://github.com/rmcelreath/rethinking

library(ape)
library(geiger)
library(phytools)
library(rethinking)
library(dplyr)
library(cmdstanr)


# Keep this script file in the same folder as the three input files (population data, species variables, phylogeny)
# This command will then tell R where to find these input files
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

# Loading the data

source("AnalysisCode/FemaleDominance_LoadData.r")

source("https://raw.githubusercontent.com/dieterlukas/primate_power/main/AnalysisCode/FemaleDominance_LoadData.r")

```





### Description of variables
The study is based on published reports on inter-sexual interactions within social groups from across primate species. To assess which of the two sexes tends to be dominant within groups, we collected both quantitative measures of aggressive and dominance interactions and qualitative descriptions of relationships. Here, we focus on three measures: (i) the proportion of decided inter-sexual aggressive interactions won by females; (ii) a strict classification of whether the majority of individuals of one sex can be considered dominant over individuals of the other sex (>90% of aggressive interactions are won by individuals of one sex) or whether there is co-dominance without a clear pattern (for the purpose of our analyses we assume that this is a linear order, with co-dominance in between female and male dominance); and (iii) a more relaxed classification that indicates whether generally females or males are more dominant in intersexual interactions (which sex wins >50% of all aggressive interactions or has been described as dominant). 

The three measures were collected on the level of individual reports of social groups, where groups were defined by the authors of the original reports. From these reports, we added information specific to this observation (circumstances of data collection, group size and composition, breeding system), generating the population-level dataset. In addition, we built a species-level dataset that contains for each of the species for which we have observations data on additional variables that are not available for each population and usually vary more among than within species. The following is the list of variables related to each of the four hypotheses we assessed:



Hypothesis 1	Reproductive control:		Mating Systems	Body size dimorphism	Canine size dimorphism	sex ratio	Male reproductive skew	Relative testes sizes	Arboreality	sexual receptivity	concealed ovulation	synchrony		
														
Hypothesis 2	Female sociality		Social system	average kinship	female coalitions	female dispersal								
														
Hypothesis 3	Self organisation		sex ratio	percentage male male fights	number of males	number of females	Between group conflict							
														
Hypothesis 4			captivity	environmental harshness	rainfall seasonality	rainfall unpredictability	seasonal breeding	home range overlap	number of females 	female evictions	female infanticide	Female canine size		
														
The variables measuring intersexual dominance are "perc_won_females", the quantitative measure of the percentage of fights won by females; "strictfdom", a categorical measure where 1 indicates that m




### Descriptive summary of the data

## Occurrence of intersexual conflict

Intersexual conflicts are frequent, representing nearly half of all agonistic interactions among primates: mean percentage ±SD: 48.1±21.5

Intersexual conflicts are not more (or less) frequent when most dyads in the group are between the sexes: mean estimate -0.01, 89% HPDI -0.06 - +0.04


```{r p2 variation in intersexual conflicts, echo=FALSE}

mean(combined$perc_aggression_fm,na.rm=T)
sd(combined$perc_aggression_fm,na.rm=T)

dstan_conflicts<-select(combined,corrected_species_id,perc_aggression_fm,perc_fm_dyads)
dstan_conflicts<-dstan_conflicts[complete.cases(dstan_conflicts),]

  dat_list_conflicts <- list(
    perc_aggression_fm = as.integer(dstan_conflicts$perc_aggression_fm),
    perc_fm_dyads = standardize(dstan_conflicts$perc_fm_dyads),
    total = rep(100,nrow(dstan_conflicts))
    )
  
  m_conflicts <- ulam(
    alist(
      perc_aggression_fm ~ dbinom(total,p),
      logit(p) <-a +b*perc_fm_dyads,
      a ~dnorm(0,1),   
      b ~ dnorm(0,1)
    ) , data=dat_list_conflicts , chains=4 , cores=4 , log_lik=TRUE , cmdstan=T, messages=FALSE, refresh=0)

precis(m_conflicts)  
  
```





## P1.1 	Intersexual dominance is continuous, and male-biased in primates
## P1.2 	Most of the variation in intersexual dominance is found among species, but intersexual dominance is not assumed to be fixed within species 

Our final dataset consists of 226 observations from 117 primate species of all three variables of intersexual dominance. 

With the strict classification of intersexual dominance relations, 82 observations report that males dominate over females (47 different species), in 109 there is no clear sex-bias in the intersexual dominance interactions (65 different species), and in 35 females dominate over males (28 different species). 95 species in our sample are reported with only a single pattern of strict intersexual dominance, for 21 species we found reports of both no clear sex-bias in one more observations and either female or male dominance in other population(s), and in 1 species (Miopithecus talapoin) all three patterns of strict intrasexual dominance relations were described. 

With the relaxed classification of intersexual dominance relations, males are classified as dominating over females in 128 observations (86 species) and females as dominating over males in 69 observations (64 species). With this definition, 11 species have observation of both female and of male dominance, while 106 species only have one type of dominance relation.

Of the 127 quantitative measures of aggressive intersexual interactions, 23 show that females always win and another 21 show that males always win; females win more than two-thirds of fights in 47 populations and less than one-thirds of fights in 57 populations, and in 23 populations there is no clear bias (females win between one- to two-thirds of fights).


```{r p1 variation in intersexual dominance, echo=FALSE}

# Total number of observations
nrow(combined)

# Total number of species
length(unique(combined$corrected_species_id))


# Distribution of intersexual dominance systems according to strict definition
# Occurrence of three types
table(combined$strictfdom)

# Determine how many different species there are for each type of intersexual dominance
species_femdom_summarytable<-as.data.frame((combined %>% group_by(strictfdom) %>% summarize(unique(corrected_species_id)) ))

nrow(species_femdom_summarytable[species_femdom_summarytable$strictfdom=="1",])
nrow(species_femdom_summarytable[species_femdom_summarytable$strictfdom=="2",])
nrow(species_femdom_summarytable[species_femdom_summarytable$strictfdom=="3",])

# Determine the extent of variation within species

speciesvariation_femdom_summarytable<-as.data.frame((combined %>% group_by(corrected_species_id) %>% summarize(unique(strictfdom)) ))

# How many species have only a single classification
sum(table(speciesvariation_femdom_summarytable$corrected_species_id)==1)
# How many species have two classifications
sum(table(speciesvariation_femdom_summarytable$corrected_species_id)==2)
# How many species have three classifications
sum(table(speciesvariation_femdom_summarytable$corrected_species_id)==3)

combined[combined$corrected_species_id=="Miopithecus_talapoin",]


# Distribution of proportion of aggressive interactions won by females
table(combined$perc_won_females)

sum(combined$perc_won_females<34,na.rm=T)

sum(combined$perc_won_females>66,na.rm=T)
```





## Investigation whether setting of the study influences the inference

## P1.3	Intersexual dominance interactions observed in captive settings are similar to those observed in more natural settings as social conditions in captivity tend to reflect those in the wild 
## P1.4	Intersexual dominance interactions observed in experimental settings are similar to those observed in more natural settings experiments reveal underlying power structures

For all three measures, values do not differ systematically between observations in captive groups compared to wild groups (89% compatibility estimates of difference in values between captive and wild observations of quantitative measure: -0.21 - +1.77; of strict classification: -0.24 - +0.75; of relaxed classification -0.53 - +0.58). For the six species for which quantitative measures exist both from captive and from wild observations, there are usually only small differences and captive values are as likely to be higher than to be lower. 

Observations which involved experimental manipulations around intersexual interactions are less likely to reveal male dominance than either co-dominance or female dominance (4% of reports of male dominance are from experimental settings, compared to 13% of reports of co-dominance and 11% of reports of female dominance). However, this difference appears to reflect biases in the choice of species in which to conduct such experiments, with no differences in the strict dominance classification when accounting for species difference between experimental and non-experimental studies (-0.29 - +1.35). Both observational and experimental data exist for three species: for two (Cercocebus atys and Callithrix jacchus) there is no difference in classification in the experiment, while for one (Ateles belzebuth) males are dominant in the experimental setting while there was co-dominance in the observational setting (opposite direction than the overall pattern for experimental data). 

Based on these findings, we combine all observations for the following analyses.



## Phylogenetic signal of intersexual dominance

## P1.4 	There is only limited phylogenetic inertia in intersexual dominance relationships, reflecting the conservatism of social systems such as cooperative breeding

All three variables of intersexual dominance show consistent, but limited phylogenetic signals: percentage fights won by females Blomberg's K 0.32 (p=0.001), strict intersexual dominance K 0.20 (p=0.001), relaxed intersexual dominance K 0.21 (p=0.001)

The phylogenetic covariance approach suggests that the percentage of fights that females can win changes in a somewhat Brownian fashion, with no very high covariances and a steady decline of covariance over phylogenetic distance.

In contrast, both the three- and the two-way classification of whether females are dominant or not show extremely high phylogenetic signal at the level of Families, which drops to zero beyond that. For the three-way classification (female/co/male dominance), this reflects that states deeper in the tree cannot be accurately reconstructed (see also the figure). For the two-way classification (female/male dominance), this reflects that the trait is very stable. There is a single transition at the root splitting strepsirrhines from haplorhines, plus 10 transitions which occur on terminal branches. 

These evolutionary patterns limit the ability to reconstruct co-evolutionary patterns for the two discrete traits. States in the the three-way, strict classification changes so frequently that there is high uncertainty around deeper parts of the tree; whereas states in the two-way strict classification change so rarely that there is not a lot of power to detect co-evolutionary patterns.


```{r p1.4 phylogeny, echo=FALSE}

source("AnalysisCode/FemaleDominance_PhylogeneticSignal.r")

```






### Definition of functions to build statistical models to assess correlations with predictor variables

We link each of the predictor variables to the three outcome variables measuring intersexual dominance in Bayesian regression models. There are different models reflecting the different outcome variables, whether the predictor variable is continuous or discrete, and whether the shared phylogenetic history among species is taken into account or not. For each of the unique combination of outcome variable and type of predictor variable, we built functions that can be called to automatically complete the respective set of analyses for a given predictor variable. 


```{r functions, echo=FALSE}

source("AnalysisCode/FemaleDominance_FunctionsPairwise.r")


```






### Correlations with predictor variables

The correlations of the three variables measuring intersexual dominance and the set of predictor variables are shown in the output table "intersexualdominance_combinedresults.csv".


```{r p2.1 mating system, echo=FALSE}

# Running the analyses with the predictor variables



allcontinuouspredictors<-c("sexratio", "SexualDimorphism_MaleWeight_over_FemaleWeight", "CanineDimorphism", "female_average_relatedness", "Synchrony", "r_seasonality_value", "M_skew_index", "env_harshness", "rainfall_unpredictability","rainfall_annualvariation","NDVI_Seasonality", "female_canine_height", "male_canine_height", "females","males","homerange_overlap","fissionfusion","perc_aggression_mm","sexualreceptivity_hours","receptive_synchrony","body_mass","relative_testes_mass","relative_femalecaninesize")

continuous_sexualselection<-c("SexualDimorphism_MaleWeight_over_FemaleWeight", "CanineDimorphism","sexratio","M_skew_index","relative_testes_mass","sexualreceptivity_hours","Synchrony")
continuous_femalesociality<-c("female_average_relatedness")
continuous_selforganisation<-c("sexratio","perc_aggression_mm","males","females")
continuous_femalecompetition<-c("env_harshness","rainfall_unpredictability","rainfall_annualvariation","NDVI_Seasonality","r_seasonality_value","homerange_overlap","females","relative_femalecaninesize")

alldiscretepredictors<-c("SocOrgPMK","MatSysPMK","female_dispersal","male_dispersal","sexbias_dispersal","jointaggression_females","jointaggression_males","female_evictions","female_infanticide" ,"ovulation_signs","Strata_Wilman","origin","between_groupconflict")

discrete_sexualselection<-c("MatSysPMK","Strata_Wilman","ovulation_signs")
discrete_selforganisation<-c("between_groupconflict")
discrete_femalesociality<-c("SocOrgPMK","jointaggression_females","sexbias_dispersal")
discrete_femalecompetition<-c("origin","female_evictions","female_infanticide","fissionfusion")

samplesizetable<-matrix(ncol=5,nrow=length(allcontinuouspredictors)+length(alldiscretepredictors))
samplesizetable<-as.data.frame(samplesizetable)
colnames(samplesizetable)<-c("predictorvariable","sample size categorical classification","number of species categorical classification", "sample size percentage fights won", "number of species percentage fights won")
count<-1

for(i in 1:length(allcontinuouspredictors)){
  continuouspredictor<-allcontinuouspredictors[i]
  colnames(combined)[colnames(combined) %in% continuouspredictor]<-c("continuouspredictor")
  samplesizetable[count,1]<-continuouspredictor
  samplesizetable[count,2]<-nrow(combined[is.na(combined$continuouspredictor)==F,])
  samplesizetable[count,3]<-length(unique(combined[is.na(combined$continuouspredictor)==F,]$corrected_species_id))
  samplesizetable[count,4]<-nrow(combined[is.na(combined$continuouspredictor)==F & is.na(combined$perc_won_females)==F,])
  samplesizetable[count,5]<-length(unique(combined[is.na(combined$continuouspredictor)==F & is.na(combined$perc_won_females)==F,]$corrected_species_id))
  colnames(combined)[colnames(combined) %in% "continuouspredictor"]<-c(continuouspredictor)
  count<-count+1
}

for(i in 1:length(alldiscretepredictors)){
  discretepredictor<-alldiscretepredictors[i]
  colnames(combined)[colnames(combined) %in% discretepredictor]<-c("discretepredictor")
    samplesizetable[count,1]<-discretepredictor
  samplesizetable[count,2]<-nrow(combined[is.na(combined$discretepredictor)==F,])
  samplesizetable[count,3]<-length(unique(combined[is.na(combined$discretepredictor)==F,]$corrected_species_id))
  samplesizetable[count,4]<-nrow(combined[is.na(combined$discretepredictor)==F & is.na(combined$perc_won_females)==F,])
  samplesizetable[count,5]<-length(unique(combined[is.na(combined$discretepredictor)==F & is.na(combined$perc_won_females)==F,]$corrected_species_id))
  colnames(combined)[colnames(combined) %in% "discretepredictor"]<-c(discretepredictor)
  count<-count+1
}

write.csv(samplesizetable,file="./results/FemdomAnalyses_Samplesizes.csv")


for (k in 1:1){

# Start with the continuous predictors

for (i in 1:length(allcontinuouspredictors)){
  continuouspredictor<-allcontinuouspredictors[i]
  print(c("continuous",i,"of",length(allcontinuouspredictors),continuouspredictor))
  results<-run_analyses_continuouspredictor(continuouspredictor)
  ifelse(i==1,allresults<-results,allresults<-rbind(allresults,results))
  }


# Next with the discrete predictors

for (j in 1:length(alldiscretepredictors)){
  discretepredictor<-alldiscretepredictors[j]
  print(c("discrete",j,"of",length(alldiscretepredictors),discretepredictor))
  results<-run_analyses_discretepredictor(discretepredictor)
  ifelse(j==1,alldiscreteresults<-results,alldiscreteresults<-rbind(alldiscreteresults,results))
}

  colnames(alldiscreteresults)<-colnames(allresults)
  combinedresults<-rbind(allresults,alldiscreteresults)
  
  
combinedresults$association_present<-ifelse(combinedresults$'estimate lower'*combinedresults$'estimate upper'<0,"not","confident" )

write.csv(combinedresults,file="./results/intersexualdominance_combinedresults.csv")

}



```




Prepare the table for the results

```{r functions nested, echo=FALSE}

combinedresults<-read.csv("results/intersexualdominance_combinedresults.csv")

combinedresults<-combinedresults[combinedresults$phylogeny=="Yes",]

combinedresults$estimate.lower<-round(combinedresults$estimate.lower,3)
combinedresults$estimate.upper<-round(combinedresults$estimate.upper,3)

sexualselection_males<-c("MatSysPMK","SexualDimorphism_MaleWeight_over_FemaleWeight", "CanineDimorphism","sexratio","M_skew_index")
sexualselection_females<-c("Strata_Wilman","sexualreceptivity_hours","relative_testes_mass","ovulation_signs","Synchrony")
socialbonds<-c("SocOrgPMK","female_average_relatedness","jointaggression_females","sexbias_dispersal")
selforganisation<-c("sexratio","perc_aggression_mm","males")
femalecompetition_environment<-c("origin","env_harshness","rainfall_annualvariation","rainfall_unpredictability")
femalecompetition_social<-c("female_evictions","female_infanticide","r_seasonality_value","homerange_overlap","females","relative_femalecaninesize","fissionfusion")

r_percwon<-combinedresults[combinedresults$outcome %in% "perc_won",]
r_strictdominance<-combinedresults[combinedresults$outcome %in% "strict three way",]
r_strictfemale<-combinedresults[combinedresults$outcome %in% "strict female dominance",]
r_strictmale<-combinedresults[combinedresults$outcome %in% "strict male dominance",]

r_sm_percwon<-r_percwon[unique(grep(paste(sexualselection_males,collapse="|"),r_percwon$continuouspredictor)),]
r_sm_percwon<-r_sm_percwon[c(5:10,2,3,1,4),]
r_sf_percwon<-r_percwon[unique(grep(paste(sexualselection_females,collapse="|"),r_percwon$continuouspredictor)),]
r_sf_percwon<-r_sf_percwon[c(7:9,2,3,4:6,1),]
r_sb_percwon<-r_percwon[unique(grep(paste(socialbonds,collapse="|"),r_percwon$continuouspredictor)),]
r_sb_percwon<-r_sb_percwon[c(2:4,1,8,5:7),]
r_so_percwon<-r_percwon[unique(grep(paste(selforganisation,collapse="|"),r_percwon$continuouspredictor)),]
r_so_percwon<-r_so_percwon[c(1,4,3),]
r_fe_percwon<-r_percwon[unique(grep(paste(femalecompetition_environment,collapse="|"),r_percwon$continuouspredictor)),]
r_fe_percwon<-r_fe_percwon[c(5,1,3,2),]
r_fs_percwon<-r_percwon[unique(grep(paste(femalecompetition_social,collapse="|"),r_percwon$continuouspredictor)),]
r_fs_percwon<-r_fs_percwon[c(6,7,1,8,3,2,4),]


r_sm_strictdominance<-r_strictdominance[unique(grep(paste(sexualselection_males,collapse="|"),r_strictdominance$continuouspredictor)),]
r_sm_strictdominance<-r_sm_strictdominance[c(5:10,2,3,1,4),]
r_sf_strictdominance<-r_strictdominance[unique(grep(paste(sexualselection_females,collapse="|"),r_strictdominance$continuouspredictor)),]
r_sf_strictdominance<-r_sf_strictdominance[c(7:9,2,3,4:6,1),]
r_sb_strictdominance<-r_strictdominance[unique(grep(paste(socialbonds,collapse="|"),r_strictdominance$continuouspredictor)),]
r_sb_strictdominance<-r_sb_strictdominance[c(2:4,1,8,5:7),]
r_so_strictdominance<-r_strictdominance[unique(grep(paste(selforganisation,collapse="|"),r_strictdominance$continuouspredictor)),]
r_so_strictdominance<-r_so_strictdominance[c(1,4,3),]
r_fe_strictdominance<-r_strictdominance[unique(grep(paste(femalecompetition_environment,collapse="|"),r_strictdominance$continuouspredictor)),]
r_fe_strictdominance<-r_fe_strictdominance[c(5,1,3,2),]
r_fs_strictdominance<-r_strictdominance[unique(grep(paste(femalecompetition_social,collapse="|"),r_strictdominance$continuouspredictor)),]
r_fs_strictdominance<-r_fs_strictdominance[c(6,7,1,8,3,2,4),]



r_sm_strictfemale<-r_strictfemale[unique(grep(paste(sexualselection_males,collapse="|"),r_strictfemale$continuouspredictor)),]
r_sm_strictfemale<-r_sm_strictfemale[c(5:10,2,3,1,4),]
r_sf_strictfemale<-r_strictfemale[unique(grep(paste(sexualselection_females,collapse="|"),r_strictfemale$continuouspredictor)),]
r_sf_strictfemale<-r_sf_strictfemale[c(7:9,2,3,4:6,1),]
r_sb_strictfemale<-r_strictfemale[unique(grep(paste(socialbonds,collapse="|"),r_strictfemale$continuouspredictor)),]
r_sb_strictfemale<-r_sb_strictfemale[c(2:4,1,8,5:7),]
r_so_strictfemale<-r_strictfemale[unique(grep(paste(selforganisation,collapse="|"),r_strictfemale$continuouspredictor)),]
r_so_strictfemale<-r_so_strictfemale[c(1,4,3),]
r_fe_strictfemale<-r_strictfemale[unique(grep(paste(femalecompetition_environment,collapse="|"),r_strictfemale$continuouspredictor)),]
r_fe_strictfemale<-r_fe_strictfemale[c(5,1,3,2),]
r_fs_strictfemale<-r_strictfemale[unique(grep(paste(femalecompetition_social,collapse="|"),r_strictfemale$continuouspredictor)),]
r_fs_strictfemale<-r_fs_strictfemale[c(6,7,1,8,3,2,4),]


r_sm_strictmale<-r_strictmale[unique(grep(paste(sexualselection_males,collapse="|"),r_strictmale$continuouspredictor)),]
r_sm_strictmale<-r_sm_strictmale[c(5:10,2,3,1,4),]
r_sf_strictmale<-r_strictmale[unique(grep(paste(sexualselection_females,collapse="|"),r_strictmale$continuouspredictor)),]
r_sf_strictmale<-r_sf_strictmale[c(7:9,2,3,4:6,1),]
r_sb_strictmale<-r_strictmale[unique(grep(paste(socialbonds,collapse="|"),r_strictmale$continuouspredictor)),]
r_sb_strictmale<-r_sb_strictmale[c(2:4,1,8,5:7),]
r_so_strictmale<-r_strictmale[unique(grep(paste(selforganisation,collapse="|"),r_strictmale$continuouspredictor)),]
r_so_strictmale<-r_so_strictmale[c(1,4,3),]
r_fe_strictmale<-r_strictmale[unique(grep(paste(femalecompetition_environment,collapse="|"),r_strictmale$continuouspredictor)),]
r_fe_strictmale<-r_fe_strictmale[c(5,1,3,2),]
r_fs_strictmale<-r_strictmale[unique(grep(paste(femalecompetition_social,collapse="|"),r_strictmale$continuouspredictor)),]
r_fs_strictmale<-r_fs_strictmale[c(6,7,1,8,3,2,4),]


```








We want to repeat the analyses for the various predictor variables split depending on a nesting variable. In particular, we want to assess the relationships separately for lemurs versus non-lemur species, and for species with high versus those with low sexual dimorphism.

```{r functions nested, echo=FALSE}

source("AnalysisCode/FemaleDominance_FunctionsNested.r")


```






### Correlations with predictor variables while nesting within another variable

We account for potential differences in the relationship between female dominance and the predictor variables between lemur and other primates, and between species with high (males more than 10% larger than females) and low degress of sexual dimorphism in body size. The correlations of the three variables measuring intersexual dominance and the set of predictor variables are shown in the output table "intersexualdominance_combinedresults_nested.csv".


```{r p2.1 dimorphism nesting, echo=FALSE}

# Running the analyses with the predictor variables

nestingvariable<-"dimorphic"

allcontinuouspredictors<-c("sexratio", "SexualDimorphism_MaleWeight_over_FemaleWeight", "CanineDimorphism", "female_average_relatedness", "Synchrony", "r_seasonality_value", "M_skew_index", "env_harshness", "rainfall_unpredictability","rainfall_annualvariation","NDVI_Seasonality", "female_canine_height", "male_canine_height", "females","males","homerange_overlap","perc_aggression_mm","sexualreceptivity_hours","receptive_synchrony","body_mass","relative_testes_mass","relative_femalecaninesize")

for(i in 1:length(allcontinuouspredictors)){
  continuouspredictor<-allcontinuouspredictors[i]
  colnames(combined)[colnames(combined) %in% continuouspredictor]<-c("continuouspredictor")
  print(allcontinuouspredictors[i])
  print("sample size")
  print(nrow(combined[is.na(combined$continuouspredictor)==F,]))
  print("number of species")
  print(length(unique(combined[is.na(combined$continuouspredictor)==F,]$corrected_species_id)))
  colnames(combined)[colnames(combined) %in% "continuouspredictor"]<-c(continuouspredictor)
}

alldiscretepredictors<-c("SocOrgPMK","MatSysPMK","female_dispersal","male_dispersal","sexbias_dispersal","jointaggression_females","jointaggression_males","female_evictions","female_infanticide" ,"ovulation_signs","Strata_Wilman","origin","between_groupconflict")


for(i in 1:length(alldiscretepredictors)){
  discretepredictor<-alldiscretepredictors[i]
  colnames(combined)[colnames(combined) %in% discretepredictor]<-c("discretepredictor")
  print(alldiscretepredictors[i])
  print("sample size")
  print(nrow(combined[is.na(combined$discretepredictor)==F,]))
  print("number of species")
  print(length(unique(combined[is.na(combined$discretepredictor)==F,]$corrected_species_id)))
  colnames(combined)[colnames(combined) %in% "discretepredictor"]<-c(discretepredictor)
}


for (k in 1:1){

# Start with the continuous predictors

for (i in 1:length(allcontinuouspredictors)){
  continuouspredictor<-allcontinuouspredictors[i]
  print(c("continuous",i,"of",length(allcontinuouspredictors),continuouspredictor))
  results<-run_analyses_continuouspredictor_nested(continuouspredictor)
  ifelse(i==1,allresults_nested<-results,allresults_nested<-rbind(allresults_nested,results))
  }


# Next with the discrete predictors

for (j in 1:length(alldiscretepredictors)){
  discretepredictor<-alldiscretepredictors[j]
  print(c("discrete",j,"of",length(alldiscretepredictors),discretepredictor))
  results<-run_analyses_discretepredictor_nested(discretepredictor)
  ifelse(j==1,alldiscreteresults_nested<-results,alldiscreteresults_nested<-rbind(alldiscreteresults_nested,results))
}
colnames(alldiscreteresults_nested)<-colnames(allresults_nested)
  combinedresults_nested<-rbind(allresults_nested,alldiscreteresults_nested)
  
}

write.csv(combinedresults_nested,file="intersexualdominance_combinedresults_nestedbydimorphism.csv")



# Running the analyses with the predictor variables

nestingvariable<-"lemur"

allcontinuouspredictors<-c("sexratio", "SexualDimorphism_MaleWeight_over_FemaleWeight", "female_average_relatedness", "Synchrony", "r_seasonality_value", "male_skew", "env_harshness", "rainfall_unpredictability","rainfall_annualvariation", "female_canine_height", "male_canine_height", "females","homerange_overlap","perc_aggression_mm","testes_mass","body_mass","receptive_synchrony")

for(i in 1:length(allcontinuouspredictors)){
  continuouspredictor<-allcontinuouspredictors[i]
  colnames(combined)[colnames(combined) %in% continuouspredictor]<-c("continuouspredictor")
  print(allcontinuouspredictors[i])
  print("sample size")
  print(nrow(combined[is.na(combined$continuouspredictor)==F,]))
  print("number of species")
  print(length(unique(combined[is.na(combined$continuouspredictor)==F,]$corrected_species_id)))
  colnames(combined)[colnames(combined) %in% "continuouspredictor"]<-c(continuouspredictor)
}

alldiscretepredictors<-c("monopolization", "jointaggression_males", "jointaggression_females", "female_dispersal", "female_infanticide", "female_evictions", "sexbias_dispersal", "MatSysPMK", "SocOrgPMK","between_groupconflict")

for(i in 1:length(alldiscretepredictors)){
  discretepredictor<-alldiscretepredictors[i]
  colnames(combined)[colnames(combined) %in% discretepredictor]<-c("discretepredictor")
  print(alldiscretepredictors[i])
  print("sample size")
  print(nrow(combined[is.na(combined$discretepredictor)==F,]))
  print("number of species")
  print(length(unique(combined[is.na(combined$discretepredictor)==F,]$corrected_species_id)))
  colnames(combined)[colnames(combined) %in% "discretepredictor"]<-c(discretepredictor)
}


for (k in 1:1){

# Start with the continuous predictors

for (i in 1:length(allcontinuouspredictors)){
  continuouspredictor<-allcontinuouspredictors[i]
  print(c("continuous",i,"of",length(allcontinuouspredictors),continuouspredictor))
  results<-run_analyses_continuouspredictor_nested(continuouspredictor)
  ifelse(i==1,allresults<-results,allresults<-rbind(allresults,results))
  }


# Next with the discrete predictors

for (j in 1:length(alldiscretepredictors)){
  discretepredictor<-alldiscretepredictors[j]
  print(c("discrete",j,"of",length(alldiscretepredictors),discretepredictor))
  results<-run_analyses_discretepredictor_nested(discretepredictor)
  ifelse(j==1,alldiscreteresults<-results,alldiscreteresults<-rbind(alldiscreteresults,results))
}

  colnames(alldiscreteresults)<-colnames(allresults)
  combinedresults<-rbind(allresults,alldiscreteresults)
  
  write.csv(combinedresults,file="intersexualdominance_combinedresults_nestedbylemur.csv")

  
}



```






Prepare the table for the results

```{r functions nested, echo=FALSE}

nestedresults<-read.csv("results/intersexualdominance_combinedresults_nestedbydimorphism_2023.csv")

nestedresults<-nestedresults[nestedresults$phylogeny=="yes",]

nestedresults$estimate.lower<-round(nestedresults$contrast.lower,3)
nestedresults$estimate.upper<-round(nestedresults$contrast.upper,3)

sexualselection_males<-c("MatSysPMK","SexualDimorphism_MaleWeight_over_FemaleWeight", "CanineDimorphism","sexratio","M_skew_index")
sexualselection_females<-c("Strata_Wilman","sexualreceptivity_hours","relative_testes_mass","ovulation_signs","Synchrony")
socialbonds<-c("SocOrgPMK","female_average_relatedness","jointaggression_females","sexbias_dispersal")
selforganisation<-c("sexratio","perc_aggression_mm","males")
femalecompetition_environment<-c("origin","env_harshness","rainfall_annualvariation","rainfall_unpredictability")
femalecompetition_social<-c("female_evictions","female_infanticide","r_seasonality_value","homerange_overlap","females","relative_femalecaninesize")

r_percwon<-nestedresults[nestedresults$outcome %in% "perc_won",]
r_strictdominance<-nestedresults[nestedresults$outcome %in% "strict",]

r_percwon_notdimorphic<-r_percwon[seq(from=1,to=69,by=2),]
r_percwon_notdimorphic<-r_percwon_notdimorphic[,c(3,7,8)]
r_percwon_dimorphic<-r_percwon[seq(from=2,to=70,by=2),]
r_percwon_dimorphic<-r_percwon_dimorphic[,c(3,7,8)]

r_strictdominance_notdimorphic<-r_strictdominance[seq(from=1,to=69,by=2),]
r_strictdominance_notdimorphic<-r_strictdominance_notdimorphic[,c(3,7,8)]
r_strictdominance_dimorphic<-r_strictdominance[seq(from=2,to=70,by=2),]
r_strictdominance_dimorphic<-r_strictdominance_dimorphic[,c(3,7,8)]



r_sm_percwon_notdimorphic<-r_percwon_notdimorphic[unique(grep(paste(sexualselection_males,collapse="|"),r_percwon_notdimorphic$nestingvariable)),]

r_sf_percwon_notdimorphic<-r_percwon_notdimorphic[unique(grep(paste(sexualselection_females,collapse="|"),r_percwon_notdimorphic$nestingvariable)),]

write.csv(rbind(r_sm_percwon_notdimorphic,r_sf_percwon_notdimorphic),file="results/Table_S7.csv")

r_sb_percwon_notdimorphic<-r_percwon_notdimorphic[unique(grep(paste(socialbonds,collapse="|"),r_percwon_notdimorphic$nestingvariable)),]

r_so_percwon_notdimorphic<-r_percwon_notdimorphic[unique(grep(paste(selforganisation,collapse="|"),r_percwon_notdimorphic$nestingvariable)),]

r_fe_percwon_notdimorphic<-r_percwon_notdimorphic[unique(grep(paste(femalecompetition_environment,collapse="|"),r_percwon_notdimorphic$nestingvariable)),]

r_fs_percwon_notdimorphic<-r_percwon_notdimorphic[unique(grep(paste(femalecompetition_social,collapse="|"),r_percwon_notdimorphic$nestingvariable)),]

write.csv(rbind(r_sb_percwon_notdimorphic,r_so_percwon_notdimorphic,r_fe_percwon_notdimorphic,r_fs_percwon_notdimorphic),file="results/Table_S8.csv")


r_sm_percwon_dimorphic<-r_percwon_dimorphic[unique(grep(paste(sexualselection_males,collapse="|"),r_percwon_dimorphic$nestingvariable)),]

r_sf_percwon_dimorphic<-r_percwon_dimorphic[unique(grep(paste(sexualselection_females,collapse="|"),r_percwon_dimorphic$nestingvariable)),]

write.csv(rbind(r_sm_percwon_dimorphic,r_sf_percwon_dimorphic),file="results/Table_S9.csv")


r_sb_percwon_dimorphic<-r_percwon_dimorphic[unique(grep(paste(socialbonds,collapse="|"),r_percwon_dimorphic$nestingvariable)),]

r_so_percwon_dimorphic<-r_percwon_dimorphic[unique(grep(paste(selforganisation,collapse="|"),r_percwon_dimorphic$nestingvariable)),]

r_fe_percwon_dimorphic<-r_percwon_dimorphic[unique(grep(paste(femalecompetition_environment,collapse="|"),r_percwon_dimorphic$nestingvariable)),]

r_fs_percwon_dimorphic<-r_percwon_dimorphic[unique(grep(paste(femalecompetition_social,collapse="|"),r_percwon_dimorphic$nestingvariable)),]

write.csv(rbind(r_sb_percwon_dimorphic,r_so_percwon_dimorphic,r_fe_percwon_dimorphic,r_fs_percwon_dimorphic),file="results/Table_S10.csv")




r_sm_strictdominance_notdimorphic<-r_strictdominance_notdimorphic[unique(grep(paste(sexualselection_males,collapse="|"),r_strictdominance_notdimorphic$nestingvariable)),]

r_sf_strictdominance_notdimorphic<-r_strictdominance_notdimorphic[unique(grep(paste(sexualselection_females,collapse="|"),r_strictdominance_notdimorphic$nestingvariable)),]

write.csv(rbind(r_sm_strictdominance_notdimorphic,r_sf_strictdominance_notdimorphic),file="results/Table_S11.csv")


r_sb_strictdominance_notdimorphic<-r_strictdominance_notdimorphic[unique(grep(paste(socialbonds,collapse="|"),r_strictdominance_notdimorphic$nestingvariable)),]

r_so_strictdominance_notdimorphic<-r_strictdominance_notdimorphic[unique(grep(paste(selforganisation,collapse="|"),r_strictdominance_notdimorphic$nestingvariable)),]

r_fe_strictdominance_notdimorphic<-r_strictdominance_notdimorphic[unique(grep(paste(femalecompetition_environment,collapse="|"),r_strictdominance_notdimorphic$nestingvariable)),]

r_fs_strictdominance_notdimorphic<-r_strictdominance_notdimorphic[unique(grep(paste(femalecompetition_social,collapse="|"),r_strictdominance_notdimorphic$nestingvariable)),]

write.csv(rbind(r_sb_strictdominance_notdimorphic,r_so_strictdominance_notdimorphic,r_fe_strictdominance_notdimorphic,r_fs_strictdominance_notdimorphic),file="results/Table_S12.csv")


r_sm_strictdominance_dimorphic<-r_strictdominance_dimorphic[unique(grep(paste(sexualselection_males,collapse="|"),r_strictdominance_dimorphic$nestingvariable)),]

r_sf_strictdominance_dimorphic<-r_strictdominance_dimorphic[unique(grep(paste(sexualselection_females,collapse="|"),r_strictdominance_dimorphic$nestingvariable)),]

write.csv(rbind(r_sm_strictdominance_dimorphic,r_sf_strictdominance_dimorphic),file="results/Table_S13.csv")

r_sb_strictdominance_dimorphic<-r_strictdominance_dimorphic[unique(grep(paste(socialbonds,collapse="|"),r_strictdominance_dimorphic$nestingvariable)),]

r_so_strictdominance_dimorphic<-r_strictdominance_dimorphic[unique(grep(paste(selforganisation,collapse="|"),r_strictdominance_dimorphic$nestingvariable)),]

r_fe_strictdominance_dimorphic<-r_strictdominance_dimorphic[unique(grep(paste(femalecompetition_environment,collapse="|"),r_strictdominance_dimorphic$nestingvariable)),]

r_fs_strictdominance_dimorphic<-r_strictdominance_dimorphic[unique(grep(paste(femalecompetition_social,collapse="|"),r_strictdominance_dimorphic$nestingvariable)),]


write.csv(rbind(r_sb_strictdominance_dimorphic,r_so_strictdominance_dimorphic,r_fe_strictdominance_dimorphic,r_fs_strictdominance_dimorphic),file="results/Table_S14.csv")


```




## Including Plots

The following code will generate the figures from the data and save them in the folder /figures.

```{r plots, echo=FALSE}

source("AnalysisCode/FemaleDominance_Figures.r")


```



### Analyses of variables explaining variation in intersexual dominance relations within species


For some species, we have data from multiple observations (different groups or different time points). The code in the following script compares the relationship between intersexual dominance and the three variables for which population-level information exists (number of females per group, number of males per group, adult sex ratio in group) either by averaging across the effect within each species or by averaging values within species to determine the effect across species. It needs to be run manually, it is not reported in the manuscript.

```{r variation, echo=FALSE}

source("AnalysisCode/FemaleDominance_VariationWithinSpecies.r")


```



### Path analyses to identify potential multi-variable interactions

In the discussion, we explore some of the potential interactions among the predictor variables. The code in the following script provides examples of the functions to include more than one predictor variables to assess their influence on the respective outcome variables measuring intersexual dominance.


```{r multifactor, echo=FALSE}

source("AnalysisCode/FemaleDominance_Multivariate.r")
```



